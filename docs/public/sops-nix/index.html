<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=45769&amp;path=livereload" data-no-instant defer></script>
	<title>Sops Nix | Abhinandh S</title>
	<link rel="canonical" href="http://localhost:45769/">
	<link rel='alternate' type='application/rss+xml' title="Abhinandh S RSS" href='/index.xml'>
	<link rel='stylesheet' type='text/css' href='/style.css'>
	<script src="script.js" defer></script>
	<link rel="icon" href="/favicon.ico">
	<meta name="description" content="SOPs and Nix: A Step-by-Step Guide In this post, we’ll explore how to set up SOPs with Nix to create a robust development environment.
Step 1 - installing sops via Flakes To start, add sops-nix as a Flake input and include the Sops module in your NixOS configuration. Here’s a basic example:
{ inputs.sops-nix.url = &#34;github:Mic92/sops-nix&#34;; # optional, not necessary for the module #inputs.sops-nix.inputs.nixpkgs.follows = &#34;nixpkgs&#34;; outputs = { self, nixpkgs, sops-nix }: { # change `yourhostname` to your actual hostname nixosConfigurations.">
	<meta name="keywords" content="blog">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="robots" content="index, follow">
	<meta charset="utf-8">
</head>
<body>
<main>
<header><h1 id="tag_Sops Nix">Sops Nix</h1></header>
<article>

<h1 id="sops-and-nix-a-step-by-step-guide">SOPs and Nix: A Step-by-Step Guide</h1>
<p>In this post, we’ll explore how to set up SOPs with Nix to create a robust development environment.</p>
<h3 id="step-1---installing-sops-via-flakes">Step 1 - installing sops via Flakes</h3>
<p>To start, add sops-nix as a Flake input and include the Sops module in your NixOS configuration. Here’s a basic example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  inputs<span style="color:#f92672">.</span>sops-nix<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:Mic92/sops-nix&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># optional, not necessary for the module</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#inputs.sops-nix.inputs.nixpkgs.follows = &#34;nixpkgs&#34;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  outputs <span style="color:#f92672">=</span> { self<span style="color:#f92672">,</span> nixpkgs<span style="color:#f92672">,</span> sops-nix }: {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># change `yourhostname` to your actual hostname</span>
</span></span><span style="display:flex;"><span>    nixosConfigurations<span style="color:#f92672">.</span>yourhostname <span style="color:#f92672">=</span> nixpkgs<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>nixosSystem {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># customize to your system</span>
</span></span><span style="display:flex;"><span>      system <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;x86_64-linux&#34;</span>;
</span></span><span style="display:flex;"><span>      modules <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">./configuration.nix</span>
</span></span><span style="display:flex;"><span>        sops-nix<span style="color:#f92672">.</span>nixosModules<span style="color:#f92672">.</span>sops
</span></span><span style="display:flex;"><span>      ];
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Replace yourhostname with the actual hostname of your machine.</p>
<h3 id="step-2---generate-an-age-key">Step 2 - Generate an Age Key</h3>
<p>Next, you need to generate an age key for encryption:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fish" data-lang="fish"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mkdir</span> <span style="color:#a6e22e">-p</span> ~/.config/sops/age
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">age-keygen</span> <span style="color:#a6e22e">-o</span> ~/.config/sops/age/keys.txt
</span></span></code></pre></div><p>** Step 3 - create a .sops.yaml file at the root of your nix config</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">keys</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#75715e">&amp;user</span> <span style="color:#ae81ff">age12zlz6lvcdk6eqaewfylg35w0syh58sm7gh53q5vvn7hd7c6nngyseftjxl</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">creation_rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path_regex</span>: <span style="color:#ae81ff">secrets/secrets.yaml$</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key_groups</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">age</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#75715e">*user</span>
</span></span></code></pre></div><p>** Step 4 - Create a sops file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fish" data-lang="fish"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sops secrets/secrets.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Files must always have a string value</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">example-key</span>: <span style="color:#ae81ff">example-value</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nesting the key results in the creation of directories.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># These directories will be owned by root:keys and have permissions 0751.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">myservice</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">my_subdir</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">my_secret</span>: <span style="color:#ae81ff">password1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fish" data-lang="fish"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat secrets/secrets.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">example-key</span>: ENC<span style="color:#f92672">[</span>AES256_GCM,data:AB8XMyid4P7mXdjj+A<span style="color:#f92672">==</span>,iv:RRsZC+V+3w22pOi/2TCjBYn/0OYsNGCu5CT1ZBSKGi0<span style="color:#f92672">=</span>,tag:zT5mlujrSuA6KKxLKL8CMQ<span style="color:#f92672">==</span>,type:str<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ENC[AES256_GCM,data:59QWbzCQCP7kLdhyjFOZe503MgegN0kv505PBNHwjp6aYztDHwx2N9+A1Bz6G/vWYo+4LpBo8/s=,iv:89q3ZXgM1wBUg5G29ROor3VXrO3QFGCvfwDoA3+G14M=,tag:hOSnEZ6DKycnF37LCXOjzg==,type:comment]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ENC[AES256_GCM,data:kUuJCkDE9JT9C+kdNe0CSB3c+gmgE4We1OoX4C1dWeoZCw/o9/09CzjRi9eOBUEL0P1lrt+g6V2uXFVq4n+M8UPGUAbRUr3A,iv:nXJS8wqi+ephoLynm9Nxbqan0V5dBstctqP0WxniSOw=,tag:ALx396Z/IPCwnlqH//Hj3g==,type:comment]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">myservice</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">my_subdir</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">my_secret</span>: ENC<span style="color:#f92672">[</span>AES256_GCM,data:hcRk5ERw60G5,iv:3Ur6iH1Yu0eu2otcEv+hGRF5kTaH6HSlrofJ5JXvewA<span style="color:#f92672">=</span>,tag:hpECXFnMhGNnAxxzuGW5jg<span style="color:#f92672">==</span>,type:str<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sops</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kms</span>: <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gcp_kms</span>: <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">azure_kv</span>: <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">hc_vault</span>: <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">age</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">- recipient</span>: age12zlz6lvcdk6eqaewfylg35w0syh58sm7gh53q5vvn7hd7c6nngyseftjxl
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">enc</span>: <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">-----BEGIN</span> AGE ENCRYPTED FILE-----
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0</span>+IFgyNTUxOSB1dFYvSTRHa3IwTVpuZjEz
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">SDZZQnc5a0dGVGEzNXZmNEY5NlZDbVgyNVU0Clo3ZC9MRGp4SHhLUTVCeWlOUUxS</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">MEtPdW4rUHhjdFB6bFhyUXRQTkRpWjAKLS0tIDVTbWU2V3dJNUZrK1A5U0c5bkc0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">S3VINUJYc3VKcjBZbHVqcGJBSlVPZWcKqPXE01ienWDbTwxo</span>+z4dNAizR3t6uTS+
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">KbmSOK1v61Ri0bsM5HItiMP</span>+fE3VCyhqMBmPdcrR92+3oBmiSFnXPA<span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">-----END</span> AGE ENCRYPTED FILE-----
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">- recipient</span>: age18jtffqax5v0t6ehh4ypaefl4mfhcrhn6ek3p80mhfp9psx6pd35qew2ww3
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">enc</span>: <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">-----BEGIN</span> AGE ENCRYPTED FILE-----
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0</span>+IFgyNTUxOSBzT3FxcDEzaFRQOVFpNkg2
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Skw4WEIxZzNTWkNBaDRhcUN2ejY4QTAwTERvCkx2clIzT2wyaFJZcjl0RkFXL2p6</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">enhqVEZ3ZkNKUU5jTlUxRC9Lb090TzAKLS0tIDBEaG00RFJDZ3ZVVjBGUWJkRHdQ</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">YkpudG43eURPVWJUejd3Znk5Z29lWlkK0cIngn2qdmiOE5rHOHxTRcjfZYuY3Ej7</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Yy7nYxMwTdYsm</span>/V6Lp2xm8hvSzBEIFL+JXnSTSwSHnCIfgle5BRbug<span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">-----END</span> AGE ENCRYPTED FILE-----
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lastmodified</span>: <span style="color:#e6db74">&#34;2021-11-20T16:21:10Z&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mac</span>: ENC<span style="color:#f92672">[</span>AES256_GCM,data:5ieT/yv1GZfZFr+OAZ/DBF+6DJHijRXpjNI2kfBun3KxDkyjiu/OFmAbsoVFY/y6YCT3ofl4Vwa56Veo3iYj4njgxyLpLuD1B6zkMaNXaPywbAhuMho7bDGEJZHrlYOUNLdBqW2ytTuFA095IncXE8CFGr38A2hfjcputdHk4R4<span style="color:#f92672">=</span>,iv:UcBXWtaquflQFNDphZUqahADkeege5OjUY38pLIcFkU<span style="color:#f92672">=</span>,tag:yy+HSMm+xtX+vHO78nej5w<span style="color:#f92672">==</span>,type:str<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pgp</span>: <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">unencrypted_suffix</span>: _unencrypted
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">version</span>: <span style="color:#ae81ff">3</span>.<span style="color:#ae81ff">7</span>.<span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  imports <span style="color:#f92672">=</span> [ <span style="color:#e6db74">&lt;sops-nix/modules/sops&gt;</span> ];
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This will add secrets.yml to the nix store</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># You can avoid this by adding a string to the full path instead, i.e.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># sops.defaultSopsFile = &#34;/root/.sops/secrets/example.yaml&#34;;</span>
</span></span><span style="display:flex;"><span>  sops<span style="color:#f92672">.</span>defaultSopsFile <span style="color:#f92672">=</span> <span style="color:#e6db74">./secrets/example.yaml</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This will automatically import SSH keys as age keys</span>
</span></span><span style="display:flex;"><span>  sops<span style="color:#f92672">.</span>age<span style="color:#f92672">.</span>sshKeyPaths <span style="color:#f92672">=</span> [ <span style="color:#e6db74">&#34;/etc/ssh/ssh_host_ed25519_key&#34;</span> ];
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This is using an age key that is expected to already be in the filesystem</span>
</span></span><span style="display:flex;"><span>  sops<span style="color:#f92672">.</span>age<span style="color:#f92672">.</span>keyFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/var/lib/sops-nix/key.txt&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This will generate a new key if the key specified above does not exist</span>
</span></span><span style="display:flex;"><span>  sops<span style="color:#f92672">.</span>age<span style="color:#f92672">.</span>generateKey <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This is the actual specification of the secrets.</span>
</span></span><span style="display:flex;"><span>  sops<span style="color:#f92672">.</span>secrets<span style="color:#f92672">.</span>example-key <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>  sops<span style="color:#f92672">.</span>secrets<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;myservice/my_subdir/my_secret&#34;</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>F</p>


<div id="nextprev"><a href="/sops-nix1/"><div id="nextart">Next:<br>Sops Nix1</div></a>
</div>
<div style="clear:both" class=taglist>Related<br><a id="tag_blog" href="http://localhost:45769/tags/blog">Blog</a></div>
</article>
</main>

<footer>
	<a href="http://localhost:45769/">http://localhost:45769/</a><br><br><a href="/index.xml"><img src="/rss.svg" style="max-height:1.5em" alt="RSS Feed" title="Subscribe via RSS for updates."></a>
</footer>

</body>
</html>
